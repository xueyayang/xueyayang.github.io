---
layout: default
---

如何实现JNI接口-Android程序JNI编程（一）
===============

1 问题
====

有时候，需要用C/C++写一些代码，供JAVA调用。这时候就要用到JNI。比如，android开发中，native层，C调用v4l2模块控制摄像头，然后写成接口被java调用。

2 方法
====

2.1 写下java层想拥有的native接口
----------------------------

1.  如在java文件里，定义这些的接口

        public native int n_start();
        public native int n_fill_bitmap(Bitmap bitmap, int n_width, int n_height)
        public native int n_stop();

2.  将.java文件编译生成.class文件，并记录完整包名：如com.example.mypackage.xx，xx.class。

2.2 用classh命令生成对应的JNI接口
-----------------------------

    mkdir JNI
    cd JNI
    mkdir -p com/zienon/util/
    cp AGLib.class com/zienon/util/
    javah -classpath . -o jni4jhk.h com.zienon.util.AGLib

这里需要说明的是： 

- AGLib.class 应该放到完整包名路径。如上面的，`com/zienon/util`。
- 如过AGLib.class
- 有内部类`internal_xxx`，对应的`AGLib#internal_xxx.class`文件也要拷贝。

### 2.2.1 可能错误
{% highlight bash %}
Error: cannot access android.app.Activity
{% endhighlight %}

这个是找不到`android.jar`。所以要在`classpath`选项后，指明android-sdk的路径。
{% highlight bash%}
javah -classpath .:/home/eric/Android_SDK_NDK/adt-bundle-linux/sdk/platforms/android-19/ -o jni4jhk.h com.zienon.util.AGLib
{% endhighlight %}

2.3 得到对应的JNI接口
-----------------

得到.h文件如下：

    /* DO NOT EDIT THIS FILE - it is machine generated */
    #include <jni.h>
    /* Header for class com_zienon_util_AGLib */

    #ifndef _Included_com_zienon_util_AGLib
    #define _Included_com_zienon_util_AGLib
    #ifdef __cplusplus
    extern "C" {
    #endif
    /*
     * Class:     com_zienon_util_AGLib
     * Method:    n_start
     * Signature: ()I
     */
    JNIEXPORT jint JNICALL Java_com_zienon_util_AGLib_n_1start
      (JNIEnv *, jobject);

    /*
     * Class:     com_zienon_util_AGLib
     * Method:    n_fillBitmap
     * Signature: (Landroid/graphics/Bitmap;II)I
     */
    JNIEXPORT jint JNICALL Java_com_zienon_util_AGLib_n_1fill_1bitmap
      (JNIEnv *, jobject, jobject, jint, jint);

    /*
     * Class:     com_zienon_util_AGLib
     * Method:    n_stop
     * Signature: ()I
     */
    JNIEXPORT jint JNICALL Java_com_zienon_util_AGLib_n_1stop
      (JNIEnv *, jobject);

    #ifdef __cplusplus
    }
    #endif
    #endif

2.4 实现这些接口
------------

尽量绕开jni特有的数据类型，像平常写C/C++程序即可。实在绕不开，查对应的手册。

3 总结
====

程序本身做什么是最重要的。语言与形式都是浮云。引用候捷的一句话：基础学问如万古长空，开发工具如一朝风月。
